---
title: "R Notebook"
---

```{r Load libraries, message = F}
if(!require(here, quietly = F)) {
  install.packages("here")
  library(here)
}
if(!require(tidyverse, quietly = F)) {
  install.packages("tidyverse")
  library(tidyverse)
}
if(!require(CEMiTool, quietly = F)) {
  BiocManager::install("CEMiTool")
  library(CEMiTool)
}
if(!require(clusterProfiler, quietly = F)) {
  BiocManager::install("clusterProfiler")
  library(clusterProfiler)
}
```

```{r Load input files}
tmm.counts <- read.delim(here("data","tmm_counts_curettage.tsv"))

phenodata <- read.delim(here("data","phenodata_curettage.tsv"))

my_gmt <- read.gmt(gmtfile = here("data", "ReactomePathwaysLevel3.gmt"))

#ensembl2hgnc <- read.delim(here("data","ensemblID_to_HGNCsymbol.txt"))
#tmp <- read.delim("/home/ftencaten/Downloads/cemitool-expression.tsv")

int_fname <- system.file("extdata", "interactions.tsv", package = "CEMiTool")
int_df <- read.delim(int_fname)
```

```{r Prepare files}
### Add ensemblID to gmt
#my_gmt <- merge(my_gmt,ensembl2hgnc,by.x = "gene",by.y = "HGNC.symbol",all.y = F)
#my_gmt <- my_gmt[,-1]
#colnames(my_gmt) <- c("term","gene")
#rownames(tmm.counts) <- tmm.counts$ID

# Interaction
#int_df_ensemblID <- int_df %>% 
#  inner_join(ensembl2hgnc, by = c("gene1symbol" = "HGNC.symbol")) %>% 
#  inner_join(ensembl2hgnc,by = c("gene2symbol" = "HGNC.symbol")) %>% 
#  select(gene1symbol = Gene.stable.ID.x, gene2symbol = Gene.stable.ID.y)

tmm.counts <- tmm.counts[!duplicated(tmm.counts$nameofG),]
rownames(tmm.counts) <- tmm.counts$nameofG

smpl.annot <- data.frame(SampleName = phenodata$label, 
                    Class = interaction(phenodata$Group, phenodata$sex))

smpl.annot$Class <- fct_relevel(smpl.annot$Class, "Children.F","Children.M","Adults.F","Adults.M",
                                "Elderly.F","Elderly.M")
 
```

```{r run CEMiToll}
#nmodules(cem.tmm)

#get_cemitool_r2_beta(cem.tmm)

#module.genes <- module_genes(cem.tmm)

#Module enrichment
#cem.tmm <- mod_gsea(cem.tmm)
#cem.tmm <- plot_gsea(cem.tmm)
#show_plot(cem.tmm, "gsea")

# Expression patterns
#cem.tmm <- plot_profile(cem.tmm)
#plots <- show_plot(cem.tmm, "profile")

# ORA analysis
#cem.tmm <- mod_ora(cem.tmm, my_gmt)
#cem.tmm <- plot_ora(cem.tmm)
#plots <- show_plot(cem.tmm, "ora")
#plots[2]

#interactions_data(cem.tmm) <- int_df_ensemblID # add interactions
#cem.tmm <- plot_interactions(cem.tmm) # generate plot
#plots <- show_plot(cem.tmm, "interaction") # view the plot for the first module

#Filter by expression
keep <- rowSums(tmm.counts[,-c(1:2)] > 1) > ncol(tmm.counts[,-c(1:2)])*0.5
tmm.counts <- tmm.counts[keep,]
 

cem.tmm <- cemitool(expr = tmm.counts[,-c(1:2)], annot = smpl.annot, apply_vst = TRUE, 
                gmt = my_gmt, interactions = int_df, verbose = TRUE)

cem.tmm.0.3 <- cemitool(expr = tmm.counts[,-c(1:2)], annot = smpl.annot, apply_vst = TRUE, 
                verbose = TRUE, filter_pval = 0.3, gmt = my_gmt, interactions = int_df)


cem.tmm.no.filter <- cemitool(expr = tmm.counts[,-c(1:2)], annot = smpl.annot, 
                              verbose = TRUE, filter = FALSE, gmt = my_gmt, 
                              interactions = int_df, gsea_max_size = 7e3)


# create report as html document
generate_report(cem.tmm.no.filter, directory = here("results","CEMiTool","report_nofilter"),
                title = "Children - Adults - Elderly / M - F / No filter")

  # write analysis results into files
write_files(cem.tmm.no.filter, directory = here("results","CEMiTool","tables_nofilter"))

# save all plots


```

